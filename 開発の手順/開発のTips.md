# 開発の Tips

## 必要なもの

- [【Windows 簡略版】環境構築の手順](../環境構築の手順/【Windows簡略版】環境構築の手順.md)か[【Mac 簡略版】環境構築の手順](../環境構築の手順/【Mac簡略版】環境構築の手順.md)のいずれかの手順をすべて行っていること。

## このマニュアルを理解するのに必要な前提知識

- [開発の手順](./開発の手順.md)に書かれた内容が理解できること。

## 1. ターミナルに表示された`[Git情報]`の意味について

ターミナルの`[Git情報]`はコマンドの終了直後か、ターミナルが起動してから 10 秒ごとに更新される。  
なお、たまに`[時刻]`が止まっている場合があり、その場合は永遠に更新されないので、何もコマンドを入れずに [Enter] して強制的に動かす。

```console
[時刻] ユーザー名 (Python仮想環境名) ワーキングディレクトリ [Git情報]
$
```

表示内容は次のような意味がある。

| 表示          | 意味                                                                                                                                                                                                   |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `[main]`      | 何も変更点がなく、リポジトリはクリーンな状態。リポジトリは`main`ブランチを参照している。                                                                                                               |
| `[main +1]`   | ステージングされたファイルが 1 つある。                                                                                                                                                                |
| `[main ●2]`   | すでにコミットされているファイル(トラックされているファイルという)の変更が 2 つある。                                                                                                                  |
| `[main …1]`   | 新しいファイル(トラックされていないファイルという)が 1 個ある。                                                                                                                                        |
| `[main 0\|1]` | ローカルリポジトリはリモートリポジトリより 1 コミット多い(先んじている)。                                                                                                                              |
| `[main 1\|3]` | ローカルリポジトリはリモートリポジトリより 3 コミット多く(先んじていて)、1 コミット少ない(遅れている)。<br />※例えば他の人がリモートブランチに変更をプッシュした場合などにローカルのコミットが遅れる。 |
| `[main *]`    | python コマンドが使えない場合は変更があるか否か(クリーンかどうか)しか表示されない。                                                                                                                    |

なお、リモートリポジトリの情報の取得は自動的には行われず、pull をした際などにしか更新されない。  
リモートリポジトリとの差分も含めて最新版の情報を取得したい場合は次を実行する。

```shell
# リモートリポジトリの情報を取得する
git fetch
```

## 2. 入力を便利にする Zsh の機能

ここでは、Zsh の様々な機能について説明する。  
なお、Zsh の機能と言っているが、厳密には Zsh 自体ではなくこのマニュアルの環境構築でいれたプラグインやコマンドの機能であるものもある。

### 上矢印キーで今まで打ったコマンドを呼び出せる

ターミナルへのコマンドの入力中に上矢印キーを打つと、今まで打ったコマンドを呼び出せる。

```shell
gi
# ここまで打った後に上矢印キーを押すと...
git push origin main
# giから始まる今まで打ったコマンドが新しい順に出てくる
```

### タブキーで補完(予測入力)が可能

これは今やシェルに限らずブラウザ等にもある機能である。

```shell
cd ~/si
# ここまで打った後にタブキーを押すと...
cd ~/simplerich-zsh-theme
# 実際にあるパスで補完してくれる
# さらにタブを押せば
cd ~/simplerich-zsh-theme/zsh-git-prompt
# さらに補完される

# ※補完の対象はパスだけでなくコマンド、オプション等、あらゆるものが対象である
```

### 打ったコマンドを全部消す場合は[Ctrl+U]

[Ctrl+U](Windows/Mac 共通)は打ったコマンドを全部削除するショートカットキーである

```shell
git push origin ma
# やっぱり別のコマンドが実行したい、Ctrl+U

# (全部消えた)
```

### コンソールをクリアする場合は[Ctrl+L]

[Ctrl+L](Windows/Mac 共通)は今までのコマンドの出力結果等を消して、コンソール画面をまっさらにするショートカットキーである。

### コマンドやプログラムを中断させるときは[Ctrl+C]

これは入力を簡単にする機能ではないが、コマンドやプログラムを途中で終了させるときは実行中に[Ctrl+C](Windows/Mac 共通)を押す。  
ただし、対応していないものもある。

### コマンドでターミナルを閉じたい場合は`exit`

VSCode 内で開いたターミナルを何らかの理由で再起動したい場合は、`exit`コマンドを実行し、[Ctrl+@]/[Ctrl+\`] とすればよい。

## 3. Git の一般的な機能

ここでは、Git の一般的な機能について説明しておく。  
ここで説明することは Tips というほど裏技的なものではなく、むしろ当たり前の機能であるが、説明する機会がなかったので説明しておく。

### `git`はリポジトリ内のどこでも実行できる

`git init`は除くが、大抵の`git`コマンドはリポジトリ内であればサブディレクトリ(ディレクトリの中のディレクトリ)の中でも実行が可能である。

```shell
cd ~/projects/testrepo
mkdir sub_folder

# リポジトリ直下で実行しても
git push origin main

# サブディレクトリ内で実行しても
cd sub_folder
git push origin main

# 同じ効果を持つ
```

### 今いるブランチのコミットの履歴の確認は`git log`

下記を実行するとコミットの履歴を表示する。  
下矢印キーでさかのぼることができ、終了する際は`q`を押す。

```shell
git log
```

### コミットの取り消しは`git reset`と`git push --force-with-lease`

ローカルのコミットの取り消しは下記のいずれかを実行する。

```shell
# 直前のコミットを無かったことにする
# (ステージング直前まで戻る場合)
git reset HEAD^

# 直前のコミットを無かったことにする
# (ステージング直後まで戻る場合)
git reset HEAD^ --soft

# 直前のコミットを無かったことにする
# (ファイルを書き換えて完全になくす場合)
git reset HEAD^ --hard
```

`HEAD`は一番最後のコミットという意味で、`HEAD^`はその直前のコミットという意味である。  
`HEAD^`を`git log`で見れるコミット ID に置き換えるとそのコミットをした直後まで戻ることができる。  
ただし、そのコミット ID より後にしたコミットが全て消えるので注意すること。

```shell
# コミットIDのコミットをした状態まで戻る
# コミットIDは 5bd085aebda774d616aa9cea2954d14183fefc6e のようなハッシュ値
# オプションは任意に変えてよい
git reset コミットID --soft
```

ローカルの変更はこれで消えるが、`git push`までしていて、リモートに反映した変更も消す必要があるときは、以下のようにして消す。

```shell
# 実行には注意が必要
git push origin ブランチ名 --force-with-lease
# または
git push origin ブランチ名 --force
# --force-with-leaseの方が安全だが--forceの方が出来ることが多い
# 違いに関してはネットで調べること。
```

`--force`とつくオプションがついているが、リモートリポジトリの変更はそう簡単には取り消せないということが分かる。  
また、`git`に限ったことではないが`--force`とつくオプションの実行は慎重になる必要がある。  
特に、複数人で作業しているリポジトリの`main`ブランチに対してこれをやることは避けたほうが良い。

代わりに、`git revert`といって、「コミットを打ち消すコミットを生成する」コマンドがある。  
これならやっていることはコミットの取り消しではなく追加であるので、通常の`git push origin ブランチ名`でリモートリポジトリに反映させることができる。  
なお、`git revert`の実際の使い方はネットで調べてほしい。

### 変更せずに過去の履歴を覗く場合は`git checkout`

```shell
# コミットIDの状態にファイルを変更する
# ただし、このモードでは編集ができない
# 本来はgit checkout コミットID
git co コミットID

# 戻る場合はブランチ名を指定する
git co ブランチ名
```

### 間違えて`git reset`した場合は`git reflog`

`git reset`で消した履歴は`git log`では見ることはできないが、今までにした操作の履歴(`reset`, `commit`, `checkout`等)は消えずに残り続ける。  
 この操作の履歴に対して`git reset`をすることで消した履歴を復活させることができる。

```shell
# git reflogで操作履歴を見る
git reflog

# 今までの操作の履歴(reset, commit, checkout等)が見れるので、
# 間違えてresetする直前の操作のHEAD@{n}という数字を覚える。
# 例えば間違えてしたresetがHEAD@{1}の場合は、HEAD@{2}と覚える
# 終了はqを押す

# そして、下記を実行する。オプションは任意に変えてよい。
git reset HEAD@{2} --hard
```

### その他

[【Windows 簡略版】環境構築の手順](../環境構築の手順/【Windows簡略版】環境構築の手順.md)か[【Mac 簡略版】環境構築の手順](../環境構築の手順/【Mac簡略版】環境構築の手順.md)の「5. Git エイリアスを設定する」でエイリアスを設定した Git のサブコマンドの意味について調べてみると良い。  
なお、`git stash`は次のセクションで説明がある。

## 4. `git stash`について

[参考サイト](https://qiita.com/chihiro/items/f373873d5c2dfbd03250)

`git stash`はコミットせずに変更を退避させることができる。  
PR を立てる必要があるのに間違えて`main`ブランチに変更を加えてしまった場合や、プログラムを書いている最中に別にやりたいことができた際等に使える。  
以下のようなコマンドがある。

```shell
# 変更を退避させる
# 退避は何度でもできる
# 本来はgit stash -uというコマンド
git su

# 変更を任意のタイミングで戻す
# 戻す変更は最後に退避させたものから
# 本来はgit stash popというコマンド
git sp

# 退避させた変更の一覧を見る
# 本来はgit stash listというコマンド
git sl
```
